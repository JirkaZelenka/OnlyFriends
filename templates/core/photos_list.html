{% extends 'base.html' %}

{% block title %}Fotky - OnlyFriends{% endblock %}

{% block content %}
<div class="content-header">
    <h2>üì∏ Fotky</h2>
    <p>Sd√≠len√© fotky z akc√≠ a odkazy na fotoalba</p>
    <div style="margin-top: 15px;">
        <a href="{% url 'core:photo_create' %}" class="btn">‚ûï P≈ôidat foto</a>
        <a href="{% url 'core:album_create' %}" class="btn" style="margin-left: 10px;">üìÅ Vytvo≈ôit album</a>
    </div>
</div>

{% if my_liked_photos %}
<div class="card" style="margin-bottom: 30px;">
    <h3>‚ù§Ô∏è Moje obl√≠ben√© fotky</h3>
    <div class="card-grid">
        {% for photo in my_liked_photos %}
        <div class="card photo-card" data-photo-id="{{ photo.id }}">
            {% if photo.image %}
                <div style="position: relative;">
                    <img src="{{ photo.image.url }}" alt="{{ photo.caption }}" style="width: 100%; border-radius: 5px; margin-bottom: 10px;">
                    <button class="like-btn {% if photo.is_liked %}liked{% endif %}" 
                            data-photo-id="{{ photo.id }}" 
                            onclick="toggleLike({{ photo.id }})"
                            style="position: absolute; top: 10px; right: 10px; background: rgba(255, 255, 255, 0.8); border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">
                        <span class="like-icon">{% if photo.is_liked %}‚ù§Ô∏è{% else %}ü§ç{% endif %}</span>
                    </button>
                </div>
            {% elif photo.album_link %}
                <p><a href="{{ photo.album_link }}" target="_blank" class="btn">üîó Otev≈ô√≠t extern√≠ album</a></p>
            {% endif %}
            {% if photo.caption %}
                <p>{{ photo.caption }}</p>
            {% endif %}
            {% if photo.event %}
                <p><strong>Akce:</strong> {{ photo.event.title }}</p>
            {% endif %}
            <div class="card-meta">
                <small>üì§ {{ photo.user.username }} ‚Ä¢ {{ photo.uploaded_at|date:"d.m.Y" }}</small>
                <div style="margin-top: 5px;">
                    <small class="like-count" data-photo-id="{{ photo.id }}">‚ù§Ô∏è <span>{{ photo.like_count }}</span></small>
                </div>
                <div style="margin-top: 10px;">
                    <a href="{% url 'core:photo_edit' photo.id %}" class="btn btn-secondary" style="font-size: 0.9rem; padding: 5px 10px;">‚úèÔ∏è Upravit</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if most_liked_photos %}
<div class="card" style="margin-bottom: 30px;">
    <h3>‚≠ê Nejobl√≠benƒõj≈°√≠ fotky</h3>
    <div class="card-grid">
        {% for photo in most_liked_photos %}
        <div class="card photo-card" data-photo-id="{{ photo.id }}">
            {% if photo.image %}
                <div style="position: relative;">
                    <img src="{{ photo.image.url }}" alt="{{ photo.caption }}" style="width: 100%; border-radius: 5px; margin-bottom: 10px;">
                    <button class="like-btn {% if photo.is_liked %}liked{% endif %}" 
                            data-photo-id="{{ photo.id }}" 
                            onclick="toggleLike({{ photo.id }})"
                            style="position: absolute; top: 10px; right: 10px; background: rgba(255, 255, 255, 0.8); border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">
                        <span class="like-icon">{% if photo.is_liked %}‚ù§Ô∏è{% else %}ü§ç{% endif %}</span>
                    </button>
                </div>
            {% elif photo.album_link %}
                <p><a href="{{ photo.album_link }}" target="_blank" class="btn">üîó Otev≈ô√≠t extern√≠ album</a></p>
            {% endif %}
            {% if photo.caption %}
                <p>{{ photo.caption }}</p>
            {% endif %}
            {% if photo.event %}
                <p><strong>Akce:</strong> {{ photo.event.title }}</p>
            {% endif %}
            <div class="card-meta">
                <small>üì§ {{ photo.user.username }} ‚Ä¢ {{ photo.uploaded_at|date:"d.m.Y" }}</small>
                <div style="margin-top: 5px;">
                    <small class="like-count" data-photo-id="{{ photo.id }}">‚ù§Ô∏è <span>{{ photo.like_count }}</span></small>
                </div>
                <div style="margin-top: 10px;">
                    <a href="{% url 'core:photo_edit' photo.id %}" class="btn btn-secondary" style="font-size: 0.9rem; padding: 5px 10px;">‚úèÔ∏è Upravit</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if albums %}
<div class="card" style="margin-bottom: 30px;">
    <h3>üìÅ Alba</h3>
    <div class="card-grid">
        {% for album in albums %}
        <div class="card">
            {% if album.intro_photo %}
                <img src="{{ album.intro_photo.url }}" alt="{{ album.name }}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 5px; margin-bottom: 10px;">
            {% else %}
                <div style="width: 100%; height: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 5px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem;">
                    üìÅ
                </div>
            {% endif %}
            <h3>{{ album.name }}</h3>
            {% if album.description %}
                <p>{{ album.description|truncatewords:15 }}</p>
            {% endif %}
            {% if album.event %}
                <p><strong>Akce:</strong> {{ album.event.title }}</p>
            {% endif %}
            {% if album.date %}
                <p><strong>Datum:</strong> {{ album.date|date:"d.m.Y" }}</p>
            {% endif %}
            <p><small><strong>Vlastn√≠k:</strong> {{ album.owner.username }}</small></p>
            <p><small><strong>Viditelnost:</strong> {{ album.get_visibility_display }}</small></p>
            <div class="card-meta">
                <a href="{% url 'core:album_detail' album.id %}" class="btn">Zobrazit album</a>
                {% if album.owner == user %}
                    <a href="{% url 'core:album_edit' album.id %}" class="btn btn-secondary" style="margin-left: 10px; font-size: 0.9rem; padding: 5px 10px;">‚úèÔ∏è Upravit</a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if standalone_photos %}
<div class="card">
    <h3>üì∏ Samostatn√© fotky</h3>
    <div class="card-grid">
        {% for photo in standalone_photos %}
        <div class="card photo-card" data-photo-id="{{ photo.id }}">
            {% if photo.image %}
                <div style="position: relative;">
                    <img src="{{ photo.image.url }}" alt="{{ photo.caption }}" style="width: 100%; border-radius: 5px; margin-bottom: 10px;">
                    <button class="like-btn {% if photo.is_liked %}liked{% endif %}" 
                            data-photo-id="{{ photo.id }}" 
                            onclick="toggleLike({{ photo.id }})"
                            style="position: absolute; top: 10px; right: 10px; background: rgba(255, 255, 255, 0.8); border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">
                        <span class="like-icon">{% if photo.is_liked %}‚ù§Ô∏è{% else %}ü§ç{% endif %}</span>
                    </button>
                </div>
            {% elif photo.album_link %}
                <p><a href="{{ photo.album_link }}" target="_blank" class="btn">üîó Otev≈ô√≠t extern√≠ album</a></p>
            {% endif %}
            {% if photo.caption %}
                <p>{{ photo.caption }}</p>
            {% endif %}
            {% if photo.event %}
                <p><strong>Akce:</strong> {{ photo.event.title }}</p>
            {% endif %}
            <div class="card-meta">
                <small>üì§ {{ photo.user.username }} ‚Ä¢ {{ photo.uploaded_at|date:"d.m.Y" }}</small>
                <div style="margin-top: 5px;">
                    <small class="like-count" data-photo-id="{{ photo.id }}">‚ù§Ô∏è <span>{{ photo.like_count }}</span></small>
                </div>
                <div style="margin-top: 10px;">
                    <a href="{% url 'core:photo_edit' photo.id %}" class="btn btn-secondary" style="font-size: 0.9rem; padding: 5px 10px;">‚úèÔ∏è Upravit</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if not albums and not standalone_photos and not my_liked_photos and not most_liked_photos %}
<div class="empty-state">
    <h3>Zat√≠m ≈æ√°dn√© fotky ani alba</h3>
    <p><a href="{% url 'core:album_create' %}" class="btn">Vytvo≈ôit prvn√≠ album</a> nebo <a href="{% url 'core:photo_create' %}" class="btn">P≈ôidat foto</a></p>
</div>
{% endif %}

<script>
function toggleLike(photoId) {
    const likeBtn = document.querySelector(`.like-btn[data-photo-id="${photoId}"]`);
    const likeIcon = likeBtn.querySelector('.like-icon');
    const likeCountEl = document.querySelector(`.like-count[data-photo-id="${photoId}"] span`);
    
    // Disable button during request
    likeBtn.disabled = true;
    
    fetch(`{% url 'core:photo_like' 0 %}`.replace('0', photoId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.liked) {
            likeIcon.textContent = '‚ù§Ô∏è';
            likeBtn.classList.add('liked');
        } else {
            likeIcon.textContent = 'ü§ç';
            likeBtn.classList.remove('liked');
        }
        if (likeCountEl) {
            likeCountEl.textContent = data.like_count;
        }
        likeBtn.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        likeBtn.disabled = false;
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<style>
.like-btn.liked {
    background: rgba(255, 0, 0, 0.2) !important;
}
.like-btn:hover {
    transform: scale(1.1);
    background: rgba(255, 255, 255, 0.95) !important;
}
.like-btn.liked:hover {
    background: rgba(255, 0, 0, 0.3) !important;
}
</style>
{% endblock %}

