{% extends 'base.html' %}

{% block title %}{{ album.name }} - OnlyFriends{% endblock %}

{% block content %}
<div class="content-header">
    <h2>{{ album.name }}</h2>
    {% if album.event %}
        <p><strong>Akce:</strong> {{ album.event.title }}</p>
    {% endif %}
    {% if album.date %}
        <p><strong>Datum:</strong> {{ album.date|date:"d.m.Y" }}</p>
    {% endif %}
    <p><strong>Vlastn√≠k:</strong> {{ album.owner.username }} ‚Ä¢ <strong>Viditelnost:</strong> {{ album.get_visibility_display }}</p>
    {% if album.description %}
        <p>{{ album.description }}</p>
    {% endif %}
    <div style="margin-top: 15px;">
        {% if album.owner == user %}
            <a href="{% url 'core:album_edit' album.id %}" class="btn btn-secondary">‚úèÔ∏è Upravit album</a>
        {% endif %}
        <a href="{% url 'core:sub_album_create' album.id %}" class="btn">‚ûï Vytvo≈ôit sub-album</a>
        <a href="{% url 'core:photo_create_album' album.id %}" class="btn" style="margin-left: 10px;">‚ûï P≈ôidat foto</a>
    </div>
</div>

{% if sub_albums %}
<div class="card" style="margin-bottom: 30px;">
    <h3>üìÇ Sub-alba</h3>
    <div class="card-grid">
        {% for sub_album in sub_albums %}
        <div class="card">
            <h3>{{ sub_album.name }}</h3>
            {% if sub_album.description %}
                <p>{{ sub_album.description|truncatewords:10 }}</p>
            {% endif %}
            <p><small>Vytvo≈ôil: {{ sub_album.created_by.username }}</small></p>
            <p><small>Fotek: {{ sub_album.photos.count }}</small></p>
            <div class="card-meta">
                <a href="{% url 'core:sub_album_detail' sub_album.id %}" class="btn">Zobrazit sub-album</a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if photos %}
<div class="card">
    <h3>üì∏ Fotky v albu</h3>
    <div class="card-grid">
        {% for photo in photos %}
        <div class="card photo-card" data-photo-id="{{ photo.id }}">
            {% if photo.image %}
                <div style="position: relative;">
                    <img src="{{ photo.image.url }}" alt="{{ photo.caption }}" style="width: 100%; border-radius: 5px; margin-bottom: 10px;">
                    <button class="like-btn {% if photo.is_liked %}liked{% endif %}" 
                            data-photo-id="{{ photo.id }}" 
                            onclick="toggleLike({{ photo.id }})"
                            style="position: absolute; top: 10px; right: 10px; background: rgba(255, 255, 255, 0.8); border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">
                        <span class="like-icon">{% if photo.is_liked %}‚ù§Ô∏è{% else %}ü§ç{% endif %}</span>
                    </button>
                </div>
            {% endif %}
            {% if photo.caption %}
                <p>{{ photo.caption }}</p>
            {% endif %}
            <div class="card-meta">
                <small>üì§ {{ photo.user.username }} ‚Ä¢ {{ photo.uploaded_at|date:"d.m.Y" }}</small>
                <div style="margin-top: 5px;">
                    <small class="like-count" data-photo-id="{{ photo.id }}">‚ù§Ô∏è <span>{{ photo.like_count }}</span></small>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<div class="empty-state">
    <h3>Zat√≠m ≈æ√°dn√© fotky v tomto albu</h3>
    <p><a href="{% url 'core:photo_create_album' album.id %}" class="btn">P≈ôidat prvn√≠ foto</a></p>
</div>
{% endif %}

<a href="{% url 'core:photos_list' %}" class="btn btn-secondary" style="margin-top: 20px;">‚Üê Zpƒõt na seznam</a>

<script>
function toggleLike(photoId) {
    const likeBtn = document.querySelector(`.like-btn[data-photo-id="${photoId}"]`);
    const likeIcon = likeBtn.querySelector('.like-icon');
    const likeCountEl = document.querySelector(`.like-count[data-photo-id="${photoId}"] span`);
    
    // Disable button during request
    likeBtn.disabled = true;
    
    fetch(`{% url 'core:photo_like' 0 %}`.replace('0', photoId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.liked) {
            likeIcon.textContent = '‚ù§Ô∏è';
            likeBtn.classList.add('liked');
        } else {
            likeIcon.textContent = 'ü§ç';
            likeBtn.classList.remove('liked');
        }
        if (likeCountEl) {
            likeCountEl.textContent = data.like_count;
        }
        likeBtn.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        likeBtn.disabled = false;
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<style>
.like-btn.liked {
    background: rgba(255, 0, 0, 0.2) !important;
}
.like-btn:hover {
    transform: scale(1.1);
    background: rgba(255, 255, 255, 0.95) !important;
}
.like-btn.liked:hover {
    background: rgba(255, 0, 0, 0.3) !important;
}
</style>
{% endblock %}

